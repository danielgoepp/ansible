---
- name: Upgrade Konnected ESPHome devices
  hosts: localhost
  gather_facts: false
  vars_files:
    - "../group_vars/esphome.yml"
  vars:
    # ESPHome configuration
    esphome_namespace: "esphome"
    esphome_deployment_name: "esphome"
    k3s_context: "k3s-prod"  # Default context, can be overridden

    # Konnected device identification patterns
    konnected_patterns:
      - "garage-door-opener"
      - "konnected"

  tasks:
    - name: Filter ESPHome devices for Konnected devices
      set_fact:
        konnected_devices: "{{ esphome_devices | selectattr('name', 'regex', pattern_regex) | list }}"
      vars:
        pattern_regex: "{{ konnected_patterns | map('regex_escape') | join('|') }}"

    - name: Display identified Konnected devices
      debug:
        msg: "Identified Konnected devices ({{ konnected_devices | length }} total):"

    - name: List Konnected devices
      debug:
        msg: "- {{ item.name }} ({{ item.config_file }}.yaml)"
      loop: "{{ konnected_devices }}"

    - name: Validate Konnected devices found
      fail:
        msg: |
          No Konnected devices found matching patterns: {{ konnected_patterns | join(', ') }}
          Available devices: {{ esphome_devices | map(attribute='name') | list | join(', ') }}
      when: konnected_devices | length == 0

    - name: Run ESPHome upgrade for Konnected devices
      include_tasks: ../tasks/ops-esphome-upgrade-devices.yaml
      vars:
        devices_to_upgrade: "{{ konnected_devices }}"
        upgrade_description: "Konnected devices"